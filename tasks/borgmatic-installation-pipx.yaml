---
# borg and borgmatic were installed via apt before.
# As we use pipx now, we have to ensure no conflicting apt packages are installed.
- name: Ensure borg and borgmatic are not installed (via apt)
  become: true
  ansible.builtin.apt:
    state: absent
    update_cache: true
    cache_valid_time: 3600  # Do not update if already done in the last hour.
    pkg:
      - borgbackup
      - borgmatic
      
- name: Ensure dependencies (via apt)
  become: true
  ansible.builtin.apt:
    state: present
    update_cache: true
    cache_valid_time: 3600  # Do not update if already done in the last hour.
    pkg:
      - python3-pip
      - python3-venv
      - pkg-config  # Needed to install borg

- name: Ensure pipx (via pip)
  ansible.builtin.pip:
    name: pipx==1.7.1
    state: present

- name: Ensure borg (via pipx)
  community.general.pipx:
    name: "borgbackup=={{ borg__borg_version }}"
  tags:
    - molecule-idempotence-notest  # TODO: Somehow this task is not idempotent.

- name: Ensure borgmatic (via pipx)
  community.general.pipx:
    name: "borgmatic=={{ borg__borgmatic_version }}"
  tags:
    - molecule-idempotence-notest  # TODO: Somehow this task is not idempotent.
